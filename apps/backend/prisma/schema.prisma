// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed password
  phone     String?
  fullName  String
  pictureUrl String? // Profile picture URL from OAuth providers
  role      String   // 'homeowner' | 'general_contractor' | 'subcontractor' | 'vendor' | 'admin'
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  homeownerProjects     Project[] @relation("HomeownerProjects")
  contractorProjects    Project[] @relation("ContractorProjects")
  sentMessages          Message[] @relation("SentMessages")
  receivedConversations Conversation[] @relation("Participants")
  vendorMaterials       Material[] @relation("VendorMaterials")
  contractorProfile     Contractor? @relation("UserContractor")
  orders                Order[] @relation("UserOrders")
  reviews               Review[] @relation("UserReviews")
  
  @@map("users")
}

model Project {
  id                  String        @id @default(uuid())
  name                String
  address             String
  homeownerId        String
  generalContractorId String?
  status              String        @default("draft") // 'draft' | 'active' | 'paused' | 'completed' | 'cancelled'
  budget              Float
  spent               Float         @default(0)
  progress            Int           @default(0)
  currentStage        String?
  startDate           DateTime?
  dueDate             DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  homeowner           User          @relation("HomeownerProjects", fields: [homeownerId], references: [id])
  generalContractor   User?         @relation("ContractorProjects", fields: [generalContractorId], references: [id])
  stages              Stage[]
  payments            Payment[]
  orders              Order[] @relation("ProjectOrders")
  
  @@map("projects")
}

model Stage {
  id              String    @id @default(uuid())
  projectId       String
  name            String
  status          String    @default("not_started") // 'not_started' | 'in_progress' | 'completed' | 'blocked'
  order           Int
  estimatedCost   Float
  actualCost      Float?
  estimatedDuration String
  startDate       DateTime?
  completionDate  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  payments        Payment[]
  
  @@map("stages")
}

model Payment {
  id            String   @id @default(uuid())
  projectId     String
  stageId       String?
  amount        Float
  status        String   @default("pending") // 'pending' | 'processing' | 'completed' | 'failed' | 'refunded'
  method        String
  transactionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  project       Project  @relation(fields: [projectId], references: [id])
  stage         Stage?   @relation(fields: [stageId], references: [id])
  
  @@map("payments")
}

model Conversation {
  id        String   @id @default(uuid())
  projectId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants User[] @relation("Participants")
  messages     Message[]
  
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  type           String       @default("text") // 'text' | 'image' | 'file'
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("SentMessages", fields: [senderId], references: [id])
  
  @@map("messages")
}

model Material {
  id          String   @id @default(uuid())
  name        String
  brand       String
  description String?
  category    String   // 'cement' | 'steel' | 'wood' | 'paint' | 'plumbing' | 'electrical' | 'tiles' | 'fixtures' | 'other'
  price       Float
  unit        String
  stock       Int      @default(0)
  rating      Float    @default(0)
  reviews     Int      @default(0)
  verified    Boolean  @default(false)
  imageUrl    String?
  vendorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  vendor     User     @relation("VendorMaterials", fields: [vendorId], references: [id])
  orderItems OrderItem[]
  materialReviews Review[] @relation("MaterialReviews")
  
  @@map("materials")
}

model Contractor {
  id          String   @id @default(uuid())
  userId      String   @unique
  name        String
  specialty   String
  description String?
  location    String?
  rating      Float    @default(0)
  reviews     Int      @default(0)
  projects    Int      @default(0)
  verified    Boolean  @default(false)
  imageUrl    String?
  hiringFee   Float
  type        String   // 'general_contractor' | 'subcontractor'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User     @relation("UserContractor", fields: [userId], references: [id], onDelete: Cascade)
  contractorReviews Review[] @relation("ContractorReviews")
  
  @@map("contractors")
}

model Order {
  id          String      @id @default(uuid())
  userId      String
  projectId   String?
  type        String      // 'material' | 'contractor'
  status      String      @default("pending") // 'pending' | 'confirmed' | 'shipped' | 'delivered' | 'cancelled'
  totalAmount Float
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user        User        @relation("UserOrders", fields: [userId], references: [id])
  project     Project?    @relation("ProjectOrders", fields: [projectId], references: [id])
  items       OrderItem[]
  
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  materialId String?
  quantity  Int
  price     Float
  createdAt DateTime @default(now())

  // Relations
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  material  Material? @relation(fields: [materialId], references: [id])
  
  @@map("order_items")
}

model Review {
  id          String   @id @default(uuid())
  userId      String
  materialId  String?
  contractorId String?
  rating      Int      // 1-5
  comment     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation("UserReviews", fields: [userId], references: [id])
  material    Material? @relation("MaterialReviews", fields: [materialId], references: [id], onDelete: Cascade)
  contractor  Contractor? @relation("ContractorReviews", fields: [contractorId], references: [id], onDelete: Cascade)
  
  @@map("reviews")
}

