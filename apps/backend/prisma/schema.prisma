// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProjectType {
  homebuilding
  renovation
  interior_design
}

enum ProjectReviewStatus {
  pending_admin_review
  changes_requested
  approved
}

enum PaymentConfirmationStatus {
  not_declared
  declared
  confirmed
  rejected
}

enum ProjectRiskLevel {
  low
  medium
  high
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed password
  phone     String?
  pictureUrl String?
  fullName  String
  role      String   // 'homeowner' | 'general_contractor' | 'subcontractor' | 'vendor' | 'admin'
  verified  Boolean  @default(false)
  stripeCustomerId String? @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  homeownerProjects     Project[] @relation("HomeownerProjects")
  contractorProjects    Project[] @relation("ContractorProjects")
  sentMessages          Message[] @relation("SentMessages")
  receivedConversations Conversation[] @relation("Participants")
  vendorMaterials       Material[] @relation("VendorMaterials")
  contractorProfile     Contractor? @relation("UserContractor")
  orders                Order[] @relation("UserOrders")
  reviews               Review[] @relation("UserReviews")
  paymentMethods        PaymentMethod[]
  createdDesigns        Design[] @relation("DesignCreatedBy")
  reviewedDesigns       Design[] @relation("DesignReviewedByAdmin")
  contractorProjectRequests ProjectRequest[] @relation("ProjectRequestContractor")
  sentProjectRequests   ProjectRequest[] @relation("ProjectRequestSender")
  houseViewingInterests HouseViewingInterest[] @relation("HomeownerViewingInterests")
  landViewingInterests  LandViewingInterest[] @relation("HomeownerLandViewingInterests")
  rentalViewingInterests RentalViewingInterest[] @relation("HomeownerRentalViewingInterests")
  homeownerDisputes     ProjectStageDispute[] @relation("HomeownerDisputes")
  gcDisputes            ProjectStageDispute[] @relation("GeneralContractorDisputes")
  pushTokens            PushToken[]
  notifications         Notification[]
  
  @@map("users")
}

model PushToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  platform  String
  app       String
  deviceId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastUsedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, app])
  @@map("push_tokens")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  isRead    Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

model Project {
  id                  String        @id @default(uuid())
  name                String
  address             String
  street              String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  latitude            Float?
  longitude           Float?
  homeownerId        String
  generalContractorId String?
  status              String        @default("draft") // 'draft' | 'active' | 'paused' | 'completed' | 'cancelled'
  riskLevel           ProjectRiskLevel @default(low)
  projectType          ProjectType? @default(homebuilding)
  reviewStatus         ProjectReviewStatus?
  externalPaymentLink  String?
  paymentDeclaredAt    DateTime?
  paymentConfirmedAt   DateTime?
  paymentConfirmationStatus PaymentConfirmationStatus @default(not_declared)
  budget              Float
  spent               Float         @default(0)
  progress            Int           @default(0)
  currentStage        String?
  startDate           DateTime?
  dueDate             DateTime?
  aiAnalysis           Json?
  aiProcessedAt        DateTime?
  planFileName         String?
  planPdfUrl           String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  homeowner           User          @relation("HomeownerProjects", fields: [homeownerId], references: [id])
  generalContractor   User?         @relation("ContractorProjects", fields: [generalContractorId], references: [id])
  stages              Stage[]
  payments            Payment[]
  projectRequests      ProjectRequest[]
  orders              Order[] @relation("ProjectOrders")
  disputes            ProjectStageDispute[]
  
  @@map("projects")
}

model Stage {
  id              String    @id @default(uuid())
  projectId       String
  name            String
  status          String    @default("not_started") // 'not_started' | 'in_progress' | 'completed' | 'blocked'
  order           Int
  estimatedCost   Float
  actualCost      Float?
  estimatedDuration String
  startDate       DateTime?
  completionDate  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  payments        Payment[]
  projectRequests ProjectRequest[]
  teamMembers     StageTeamMember[]
  materials       StageMaterial[]
  media           StageMedia[]
  documents       StageDocument[]
  disputes        ProjectStageDispute[]
  
  @@map("stages")
}

model ProjectStageDispute {
  id                 String    @id @default(uuid())
  projectId          String
  stageId            String
  homeownerId        String
  generalContractorId String?
  status             String    @default("open") // 'open' | 'in_review' | 'resolved'
  reasons            String[]  @default([])
  otherReason        String?
  resolutionNotes    String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  resolvedAt         DateTime?
  inReviewAt         DateTime?

  project            Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stage              Stage     @relation(fields: [stageId], references: [id], onDelete: Cascade)
  homeowner          User      @relation("HomeownerDisputes", fields: [homeownerId], references: [id], onDelete: Cascade)
  generalContractor  User?     @relation("GeneralContractorDisputes", fields: [generalContractorId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@index([projectId, stageId, createdAt])
  @@map("project_stage_disputes")
}

model Payment {
  id            String   @id @default(uuid())
  projectId     String
  stageId       String?
  amount        Float
  status        String   @default("pending") // 'pending' | 'processing' | 'completed' | 'failed' | 'refunded'
  method        String
  transactionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  project       Project  @relation(fields: [projectId], references: [id])
  stage         Stage?   @relation(fields: [stageId], references: [id])
  
  @@map("payments")
}

model Conversation {
  id        String   @id @default(uuid())
  projectId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants User[] @relation("Participants")
  messages     Message[]
  
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  type           String       @default("text") // 'text' | 'image' | 'file'
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("SentMessages", fields: [senderId], references: [id])
  
  @@map("messages")
}

model Material {
  id        String   @id @default(uuid())
  name      String
  category  String
  brand     String
  description String?
  price     Float
  unit      String
  rating    Float    @default(0)
  reviews   Int      @default(0)
  verified  Boolean  @default(false)
  imageUrl  String?
  stock     Int      @default(0)
  vendorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendor     User     @relation("VendorMaterials", fields: [vendorId], references: [id])
  orderItems OrderItem[]
  materialReviews Review[] @relation("MaterialReviews")
  
  @@map("materials")
}

model Contractor {
  id              String   @id @default(uuid())
  userId          String   @unique
  name            String
  specialty       String
  description     String?
  location        String?
  experienceYears Int?     // Years of experience (e.g. 15)
  rating          Float    @default(0)
  reviews         Int      @default(0)
  projects        Int      @default(0)
  verified        Boolean  @default(false)
  imageUrl        String?
  hiringFee       Float
  type            String   // 'general_contractor' | 'subcontractor'
  connectAccountId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user         User          @relation("UserContractor", fields: [userId], references: [id], onDelete: Cascade)
  contractorReviews Review[]  @relation("ContractorReviews")
  bankAccounts BankAccount[]  @relation("ContractorBankAccounts")
  certifications ContractorCertification[] @relation("ContractorCertifications")
  
  @@map("contractors")
}

model ContractorCertification {
  id            String   @id @default(uuid())
  contractorId  String
  name          String   // Display name (user-renamed)
  documentType  String?  // Optional required-verification document key
  fileUrl       String   // Path to uploaded PDF/DOCX
  expiryYear    String?  // Optional expiry year, e.g. "2026"
  createdAt     DateTime @default(now())

  contractor Contractor @relation("ContractorCertifications", fields: [contractorId], references: [id], onDelete: Cascade)

  @@map("contractor_certifications")
}

model BankAccount {
  id               String   @id @default(uuid())
  contractorId     String
  bankName         String
  accountNumber    String
  accountOwnerName String
  isDefault        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  contractor Contractor @relation("ContractorBankAccounts", fields: [contractorId], references: [id], onDelete: Cascade)

  @@map("bank_accounts")
}

model Order {
  id          String      @id @default(uuid())
  userId      String
  projectId   String?
  type        String      // 'material' | 'contractor'
  status      String      @default("pending") // 'pending' | 'confirmed' | 'shipped' | 'delivered' | 'cancelled'
  totalAmount Float
  deliveryAddress String?
  deliveryStreet  String?
  deliveryCity    String?
  deliveryState   String?
  deliveryZipCode String?
  deliveryCountry String?
  deliveryLat     Float?
  deliveryLng     Float?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user        User        @relation("UserOrders", fields: [userId], references: [id])
  project     Project?    @relation("ProjectOrders", fields: [projectId], references: [id])
  items       OrderItem[]
  
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  materialId String?
  quantity  Int
  price     Float
  createdAt DateTime @default(now())

  // Relations
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  material  Material? @relation(fields: [materialId], references: [id])
  
  @@map("order_items")
}

model Review {
  id          String   @id @default(uuid())
  userId      String
  materialId  String?
  contractorId String?
  rating      Int      // 1-5
  comment     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation("UserReviews", fields: [userId], references: [id])
  material    Material? @relation("MaterialReviews", fields: [materialId], references: [id], onDelete: Cascade)
  contractor  Contractor? @relation("ContractorReviews", fields: [contractorId], references: [id], onDelete: Cascade)
  
  @@map("reviews")
}

model PaymentMethod {
  id                   String   @id @default(uuid())
  userId               String
  brand                String
  last4                String
  expMonth              Int
  expYear               Int
  holderName           String?
  isBackup             Boolean  @default(false)
  stripePaymentMethodId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

model Design {
  id                 String   @id @default(uuid())
  name               String
  description        String?
  planType           ProjectType @default(homebuilding)
  createdById        String
  bedrooms           Int
  bathrooms          Int
  squareFootage      Float
  squareMeters       Float?
  estimatedCost      Float
  rating             Float    @default(0)
  reviews            Int      @default(0)
  isActive           Boolean  @default(true)
  adminApprovalStatus String  @default("pending") // 'pending' | 'approved' | 'rejected'
  adminReviewReason  String?
  adminReviewedAt    DateTime?
  adminReviewedById  String?
  floors             Int?
  estimatedDuration  String?
  rooms              String[] @default([])
  materials          String[] @default([])
  features           String[] @default([])
  constructionPhases Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  createdBy User          @relation("DesignCreatedBy", fields: [createdById], references: [id])
  adminReviewedBy User?   @relation("DesignReviewedByAdmin", fields: [adminReviewedById], references: [id])
  images    DesignImage[]

  @@map("designs")
}

model DesignImage {
  id        String   @id @default(uuid())
  designId  String
  url       String
  label     String?
  order     Int      @default(0)
  createdAt DateTime @default(now())

  design Design @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@map("design_images")
}

model HouseForSale {
  id               String   @id @default(uuid())
  name             String
  description      String?
  location         String
  price            Float
  bedrooms         Int
  bathrooms        Int
  squareFootage    Float
  squareMeters     Float?
  propertyType     String?
  yearBuilt        Int?
  condition        String?
  parking          Int?
  documents        String[] @default([])
  amenities        String[] @default([])
  nearbyFacilities String[] @default([])
  contactName      String?
  contactPhone     String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  images HouseForSaleImage[]
  viewingInterests HouseViewingInterest[]

  @@map("house_for_sale")
}

model HouseForSaleImage {
  id             String   @id @default(uuid())
  houseForSaleId String
  url            String
  label          String?
  order          Int      @default(0)
  createdAt      DateTime @default(now())

  houseForSale HouseForSale @relation(fields: [houseForSaleId], references: [id], onDelete: Cascade)

  @@map("house_for_sale_images")
}

model HouseViewingInterest {
  id             String   @id @default(uuid())
  houseForSaleId String
  homeownerId    String
  isRead         Boolean  @default(false)
  readAt         DateTime?
  outcomeStatus  String   @default("abandoned")
  purchaseAmount Float?
  purchaseMarkedAt DateTime?
  createdAt      DateTime @default(now())

  houseForSale HouseForSale @relation(fields: [houseForSaleId], references: [id], onDelete: Cascade)
  homeowner User @relation("HomeownerViewingInterests", fields: [homeownerId], references: [id], onDelete: Cascade)

  @@index([houseForSaleId, createdAt])
  @@index([isRead, createdAt])
  @@map("house_viewing_interests")
}

model LandForSale {
  id               String   @id @default(uuid())
  name             String
  description      String?
  location         String
  price            Float
  sizeSqm          Float
  titleDocument    String?
  zoningType       String?
  topography       String?
  roadAccess       String?
  ownershipType    String?
  documents        String[] @default([])
  nearbyLandmarks  String[] @default([])
  restrictions     String[] @default([])
  contactName      String?
  contactPhone     String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  images           LandForSaleImage[]
  viewingInterests LandViewingInterest[]

  @@map("land_for_sale")
}

model LandForSaleImage {
  id          String   @id @default(uuid())
  landForSaleId String
  url         String
  label       String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  landForSale LandForSale @relation(fields: [landForSaleId], references: [id], onDelete: Cascade)

  @@map("land_for_sale_images")
}

model LandViewingInterest {
  id             String   @id @default(uuid())
  landForSaleId  String
  homeownerId    String
  isRead         Boolean  @default(false)
  readAt         DateTime?
  outcomeStatus  String   @default("abandoned")
  purchaseAmount Float?
  purchaseMarkedAt DateTime?
  createdAt      DateTime @default(now())

  landForSale LandForSale @relation(fields: [landForSaleId], references: [id], onDelete: Cascade)
  homeowner   User @relation("HomeownerLandViewingInterests", fields: [homeownerId], references: [id], onDelete: Cascade)

  @@index([landForSaleId, createdAt])
  @@index([isRead, createdAt])
  @@map("land_viewing_interests")
}

model RentalListing {
  id               String   @id @default(uuid())
  title            String
  description      String?
  propertyType     String
  location         String
  annualRent       Float
  serviceCharge    Float
  cautionDeposit   Float
  legalFeePercent  Float
  agencyFeePercent Float    @default(2)
  bedrooms         Int
  bathrooms        Int
  sizeSqm          Float
  furnishing       String?
  paymentPattern   String?
  power            String?
  water            String?
  internet         String?
  parking          String?
  security         String?
  rules            String?
  inspectionWindow String?
  proximity        String[] @default([])
  verificationDocs String[] @default([])
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  images RentalListingImage[]
  viewingInterests RentalViewingInterest[]

  @@map("rental_listings")
}

model RentalListingImage {
  id              String   @id @default(uuid())
  rentalListingId String
  url             String
  label           String?
  order           Int      @default(0)
  createdAt       DateTime @default(now())

  rentalListing RentalListing @relation(fields: [rentalListingId], references: [id], onDelete: Cascade)

  @@map("rental_listing_images")
}

model RentalViewingInterest {
  id              String   @id @default(uuid())
  rentalListingId String
  homeownerId     String
  isRead          Boolean  @default(false)
  readAt          DateTime?
  outcomeStatus   String   @default("abandoned")
  purchaseAmount  Float?
  purchaseMarkedAt DateTime?
  createdAt       DateTime @default(now())

  rentalListing RentalListing @relation(fields: [rentalListingId], references: [id], onDelete: Cascade)
  homeowner     User          @relation("HomeownerRentalViewingInterests", fields: [homeownerId], references: [id], onDelete: Cascade)

  @@index([rentalListingId, createdAt])
  @@index([isRead, createdAt])
  @@map("rental_viewing_interests")
}

model ProjectRequest {
  id               String   @id @default(uuid())
  projectId        String
  contractorId     String
  senderId         String?
  stageId          String?
  status           String   @default("pending") // 'pending' | 'accepted' | 'rejected'
  estimatedBudget  Float?
  estimatedDuration String?
  estimatedStartDate DateTime?
  gcNotes          String?
  sentAt           DateTime @default(now())
  respondedAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  contractor User    @relation("ProjectRequestContractor", fields: [contractorId], references: [id])
  sender     User?   @relation("ProjectRequestSender", fields: [senderId], references: [id], onDelete: SetNull)
  stage      Stage?  @relation(fields: [stageId], references: [id], onDelete: SetNull)

  @@map("project_requests")
}

model StageTeamMember {
  id        String   @id @default(uuid())
  stageId   String
  name      String
  role      String
  phone     String?
  email     String?
  dailyRate Float?
  rateType  String?
  startDate DateTime?
  endDate   DateTime?
  photoUrl  String?
  invoiceUrl String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stage Stage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@map("stage_team_members")
}

model StageMaterial {
  id              String   @id @default(uuid())
  stageId          String
  name             String
  brand            String?
  quantity         Float
  unit             String
  unitPrice        Float
  totalPrice       Float
  supplier         String?
  supplierContact  String?
  receiptUrl       String?
  photoUrl         String?
  deliveryDate     DateTime?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  stage Stage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@map("stage_materials")
}

model StageMedia {
  id           String   @id @default(uuid())
  stageId      String
  type         String
  url          String
  thumbnailUrl String?
  caption      String?
  order        Int      @default(0)
  createdAt    DateTime @default(now())

  stage Stage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@map("stage_media")
}

model StageDocument {
  id        String   @id @default(uuid())
  stageId   String
  type      String
  name      String
  url       String
  category  String?
  relatedId String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stage Stage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@map("stage_documents")
}